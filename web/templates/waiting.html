{% extends 'base.html' %}

{% block content %}
<div class='container mt-5'>
    <div class='card text-center'>
        <div class='card-header'>
            <h3>正在排队评分中...</h3>
        </div>
        <div class='card-body'>
            <div class='mb-4'>
                <div class='spinner-border text-primary' role='status' style='width: 3rem; height: 3rem;'>
                    <span class='visually-hidden'>Loading...</span>
                </div>
            </div>

            <h5 class='card-title'>请稍候，系统正在处理您的试卷</h5>
            <p class='card-text' id='status-text'>正在连接实时评分服务...</p>

            <div class='progress mt-3' style='height: 20px;'>
                <div id='progress-bar-el' class='progress-bar progress-bar-striped progress-bar-animated' role='progressbar' style='width: 0%'></div>
            </div>

            <div id='queue-info' class='mt-3 text-muted' style='display: none;'>
                当前排在第 <span id='position' class='fw-bold text-danger'></span> 位，
                共有 <span id='total' class='fw-bold'></span> 人在等待。
            </div>
        </div>
    </div>
</div>

<!-- Socket.IO Integration (Offline) -->
<script src='{{ url_for('static', filename='js/socket.io.min.js') }}'></script>
<script>
    const taskId = '{{ task_id }}';
    const statusUrl = '{{ url_for('queue_status', task_id=task_id) }}';
    const resultUrl = '{{ url_for('view_history', result_id=task_id) }}';

    // Initialize Socket
    // We connect to the current origin
    const socket = io();

    socket.on('connect', () => {
        console.log('Connected to server');
        document.getElementById('status-text').innerText = '已连接到服务器，等待处理...';
        // Join the room for this task
        socket.emit('join', {room: taskId});
    });

    socket.on('status', (data) => {
        console.log('Status update:', data);
        
        if (data.status === 'processing') {
            document.getElementById('status-text').innerText = '正在评分中...';
            document.getElementById('queue-info').style.display = 'none';
            // Update progress
            const percent = data.percent || 50;
            document.getElementById('progress-bar-el').style.width = percent + '%';
        } 
        else if (data.status === 'done') {
            document.getElementById('progress-bar-el').style.width = '100%';
            document.getElementById('status-text').innerText = '评分完成！正在跳转...';
            // Wait slightly for visual confirmation
            setTimeout(() => {
                window.location.href = data.result_url || resultUrl;
            }, 500);
        }
        else if (data.status === 'error') {
             document.getElementById('status-text').innerText = '评分出错: ' + (data.error || '未知错误');
             document.querySelector('.spinner-border').classList.remove('text-primary');
             document.querySelector('.spinner-border').classList.add('text-danger');
             // Stop polling or socket
             socket.disconnect();
        }
    });
    
    socket.on('disconnect', () => {
         document.getElementById('status-text').innerText = '连接断开，尝试重连...';
    });

    // Fallback: Check standard HTTP API every 3s just in case Socket fails
    setInterval(() => {
        if (!socket.connected) {
             fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'done') {
                     window.location.href = resultUrl;
                }
            });
        }
    }, 3000);
</script>
{% endblock %}
