{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('forum.index') }}">讨论区</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('forum.view_board', board_id=topic.board_id) }}">{{ topic.board.name }}</a></li>
            <li class="breadcrumb-item active">主题详情</li>
        </ol>
    </nav>

    <!-- Topic Header -->
    <div class="card mb-3 shadow-sm border-primary">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h3 class="mb-0">
                {% if topic.is_pinned %}<span class="badge bg-danger">置顶</span>{% endif %}
                {{ topic.title }}
            </h3>
            
            {% if current_user.is_admin %}
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    管理
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <form action="{{ url_for('forum.topic_action', topic_id=topic.id) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="pin">
                            <button class="dropdown-item">{{ '取消置顶' if topic.is_pinned else '置顶' }}</button>
                        </form>
                    </li>
                    <li>
                        <form action="{{ url_for('forum.topic_action', topic_id=topic.id) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="lock">
                            <button class="dropdown-item">{{ '解锁' if topic.is_locked else '锁定' }}</button>
                        </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form action="{{ url_for('forum.topic_action', topic_id=topic.id) }}" method="POST" onsubmit="return confirm('确定删除吗？');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete">
                            <button class="dropdown-item text-danger">删除</button>
                        </form>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="d-flex mb-3 align-items-center">
                <div class="fw-bold me-3">
                    <a href="{{ url_for('user_profile', user_id=topic.user.id) }}" class="text-decoration-none" style="color: #0d6efd;">
                        <i class="bi bi-person-circle"></i> {{ topic.user.username }}
                    </a>
                </div>
                <div class="text-muted small">{{ topic.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                {% if topic.user_id == current_user.id or current_user.is_admin %}
                <a href="{{ url_for('forum.edit_topic', topic_id=topic.id) }}" class="ms-auto btn btn-sm btn-link text-decoration-none">
                    <i class="bi bi-pencil"></i> 编辑
                </a>
                {% endif %}
            </div>
            <div class="card-text form-content p-3 bg-light text-dark rounded" style="white-space: pre-wrap; font-size: 1.1em; color: black !important;">{{ topic.content }}</div>
            
            {% if topic.images %}
            <div class="mt-3">
                {% for img in topic.images %}
                <img src="{{ url_for('static', filename='uploads/' + img) }}" class="img-fluid rounded mb-2 shadow-sm" style="max-height: 400px; display: block;">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="card-footer bg-white">
            <form action="{{ url_for('forum.topic_action', topic_id=topic.id) }}" method="POST" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="like">
                <button class="btn btn-sm {{ 'btn-danger' if user_liked else 'btn-outline-danger' }}">
                    <i class="bi bi-heart{{ '-fill' if user_liked else '' }}"></i> {{ topic.likes|length }}
                </button>
            </form>
            <span class="ms-3 text-muted"><i class="bi bi-eye"></i> {{ topic.views }}</span>
        </div>
    </div>

    <!-- Replies -->
    <h5 class="mt-5 mb-3">评论 ({{ posts|length }})</h5>
    {% for post in posts %}
    <div class="card mb-3 shadow-sm" id="post-{{ post.id }}">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                <div>
                    <strong>
                        <a href="{{ url_for('user_profile', user_id=post.user.id) }}" class="text-decoration-none" style="color: #0d6efd;">
                            {{ post.user.username }}
                        </a>
                    </strong>
                    {% if post.user_id == topic.user_id %}
                    <span class="badge bg-primary ms-1">楼主</span>
                    {% endif %}
                </div>
                <small class="text-muted">#{{ loop.index }} &nbsp; {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
            
            {% if post.parent %}
            <div class="alert alert-secondary p-2 mb-2 small">
                <i class="bi bi-reply-fill"></i> 回复 <strong>{{ post.parent.user.username }}</strong>:
                <div class="text-muted text-truncate">{{ post.parent.content }}</div>
            </div>
            {% endif %}
            
            <p class="mb-0" style="white-space: pre-wrap;">{{ post.content }}</p>
            
            <div class="text-end mt-2">
                <button class="btn btn-sm btn-link text-decoration-none" onclick="replyTo({{ post.id }}, '{{ post.user.username }}')">
                    <i class="bi bi-chat-dots"></i> 回复
                </button>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Reply Form -->
    {% if not topic.is_locked %}
    <div class="card mt-4 mb-5 shadow-sm border-light">
        <div class="card-body bg-light">
            <h5 class="card-title">发表评论</h5>
            <div id="reply-target-display" class="alert alert-info py-1 px-2 mb-2 d-none">
                正在回复: <span id="reply-target-user" class="fw-bold"></span> 
                <button type="button" class="btn-close btn-sm float-end" onclick="cancelReply()"></button>
            </div>
            
            <form action="{{ url_for('forum.reply_topic', topic_id=topic.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="parent_id" id="reply-parent-id" value="">
                
                <div class="mb-3">
                    {% if current_user.is_muted %}
                        <textarea class="form-control" rows="3" disabled placeholder="您已被禁言，无法回复"></textarea>
                    {% else %}
                        <textarea name="content" id="reply-content" class="form-control" style="color: black !important; background-color: #ffffff !important;" rows="3" required placeholder="请文明发言..."></textarea>
                    {% endif %}
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary" {{ 'disabled' if current_user.is_muted else '' }}>
                        <i class="bi bi-send"></i> 提交评论
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-secondary mt-4">该主题已被锁定，无法评论。</div>
    {% endif %}
</div>

<script>
function replyTo(postId, username) {
    document.getElementById('reply-parent-id').value = postId;
    document.getElementById('reply-target-user').innerText = username;
    document.getElementById('reply-target-display').classList.remove('d-none');
    document.getElementById('reply-content').focus();
    // Scroll to form
    const formOptions = { behavior: 'smooth', block: 'center' };
    document.querySelector('.card-title').scrollIntoView(formOptions);
}

function cancelReply() {
    document.getElementById('reply-parent-id').value = '';
    document.getElementById('reply-target-display').classList.add('d-none');
}
</script>
{% endblock %}