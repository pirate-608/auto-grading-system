{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white py-3 border-bottom">
    <h2 class="mb-0">在线答题</h2>
    {% if remaining_sec is defined %}
    <div class="alert alert-primary mb-0 py-2 shadow-sm">
        ⏳ 剩余时间：<span id="timer" class="fw-bold fs-5">加载中...</span>
    </div>
    {% endif %}
</div>

<form method="POST" action="{{ url_for('exam.exam') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    {% for q in questions %}
    <div class="card mb-3">
        <div class="card-header">
                题目 {{ loop.index }} ({{ q.score }} 分)
                {% if q.type == 'personal' %}
                    <span class="badge bg-warning text-dark ms-2">个人题目</span>
                {% else %}
                    <span class="badge bg-primary ms-2">公共题目</span>
                {% endif %}
        </div>
        <div class="card-body">
            <h5 class="card-title" style="white-space: pre-wrap;">{{ q.content }}</h5>
            {% if q.image %}
            <div class="mb-3">
                <img src="{{ url_for('main.uploaded_file', filename=q.image) }}" class="img-fluid rounded" style="max-height: 300px;" alt="题目图片">
            </div>
            {% endif %}
            <div class="mb-3">
                <label for="q_{{ loop.index0 }}" class="form-label">你的答案：</label>
                <input type="text" class="form-control" id="q_{{ loop.index0 }}" name="q_{{ loop.index0 }}">
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h4>题库为空</h4>
        <p>目前还没有题目，请先去添加题目吧！</p>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">返回首页</a>
    </div>
    {% endfor %}
    
    {% if questions %}
    <button type="submit" class="btn btn-success btn-lg">提交</button>
    {% endif %}
</form>

{% if questions %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. 防止后退 (简单的历史记录堆栈操作)
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        // 2. 防止意外刷新/关闭
        window.onbeforeunload = function() {
            return "您正在答题中，确定要离开吗？您的进度已保存在本地。";
        };

        // 3. 表单自动缓存
        const inputs = document.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
            // 恢复缓存
            const saved = localStorage.getItem('exam_' + input.id);
            if (saved) {
                input.value = saved;
            }

            // 监听输入并保存
            input.addEventListener('input', function() {
                localStorage.setItem('exam_' + this.id, this.value);
            });
        });

        // 提交时清除缓存和警告
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(event) {
                // 提交确认
                if (!confirm("确定要提交答卷吗？提交后将无法修改答案。")) {
                    event.preventDefault();
                    return;
                }

                window.onbeforeunload = null;
                inputs.forEach(input => {
                    localStorage.removeItem('exam_' + input.id);
                });
            });
        }

        // 4. 禁止回车键提交表单
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                event.preventDefault();
                return false;
            }
        });

        // 倒计时逻辑
        {% if remaining_sec is defined %}
        let timeLeft = {{ remaining_sec }};
        const timerDisplay = document.getElementById('timer');
        
        function updateTimer() {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = "00:00";
                // 避免重复提交
                if (!window.isSubmitting) {
                    window.isSubmitting = true;
                    alert("答题时间到！系统将自动提交试卷。");
                    window.onbeforeunload = null; // 允许提交
                    document.querySelector('form').submit();
                }
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 最后5分钟变红
            if (timeLeft < 300) { 
                timerDisplay.parentElement.classList.remove('alert-primary');
                timerDisplay.parentElement.classList.add('alert-danger');
            }
            
            timeLeft--;
        }
        
        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // 立即执行一次
        {% endif %}
    });
</script>
{% endif %}
{% endblock %}
