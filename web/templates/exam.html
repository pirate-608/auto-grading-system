{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">在线考试</h2>
<form method="POST" action="/exam">
    {% for q in questions %}
    <div class="card mb-3">
        <div class="card-header">
            题目 {{ loop.index }} ({{ q.score }} 分)
        </div>
        <div class="card-body">
            <h5 class="card-title" style="white-space: pre-wrap;">{{ q.content }}</h5>
            {% if q.image %}
            <div class="mb-3">
                <img src="{{ url_for('static', filename='uploads/' + q.image) }}" class="img-fluid rounded" style="max-height: 300px;" alt="题目图片">
            </div>
            {% endif %}
            <div class="mb-3">
                <label for="q_{{ loop.index0 }}" class="form-label">你的答案：</label>
                <input type="text" class="form-control" id="q_{{ loop.index0 }}" name="q_{{ loop.index0 }}">
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h4>题库为空</h4>
        <p>目前还没有题目，请先去添加题目吧！</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">返回首页</a>
    </div>
    {% endfor %}
    
    {% if questions %}
    <button type="submit" class="btn btn-success btn-lg">提交试卷</button>
    {% endif %}
</form>

{% if questions %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. 防止后退 (简单的历史记录堆栈操作)
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        // 2. 防止意外刷新/关闭
        window.onbeforeunload = function() {
            return "您正在考试中，确定要离开吗？您的进度已保存在本地。";
        };

        // 3. 表单自动缓存
        const inputs = document.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
            // 恢复缓存
            const saved = localStorage.getItem('exam_' + input.id);
            if (saved) {
                input.value = saved;
            }

            // 监听输入并保存
            input.addEventListener('input', function() {
                localStorage.setItem('exam_' + this.id, this.value);
            });
        });

        // 提交时清除缓存和警告
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function() {
                window.onbeforeunload = null;
                inputs.forEach(input => {
                    localStorage.removeItem('exam_' + input.id);
                });
            });
        }
    });
</script>
{% endif %}
{% endblock %}
