{% extends "base.html" %}

{% block content %}
<div class="p-5 mb-4 rounded-3" style="background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #333;">
    <div class="container-fluid py-5">
        <h1 class="display-5 fw-bold text-white">Night's Watch Window (NWW)</h1>
        <p class="col-md-8 fs-4 text-muted">å®ˆå¤œäººä¹‹çª— â€”â€” è‡´åŠ›äºä¸º67656ä¸ªç”¨æˆ·å¼€å‘çš„çº¿ä¸Šå¤œç©ºã€‚</p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('exam.start_exam') }}" class="btn btn-outline-light btn-lg px-4 me-md-2">âš”ï¸ å¼€å§‹è¯•ç‚¼</a>
                {% if current_user.is_admin %}
                    <a href="{{ url_for('admin.add') }}" class="btn btn-outline-secondary btn-lg px-4">ğŸ“œ å‘å¸ƒä»»åŠ¡</a>
                {% endif %}
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light btn-lg px-4 me-md-2">ç™»å½•</a>
                <a href="{{ url_for('auth.register') }}" class="btn btn-outline-secondary btn-lg px-4">æ³¨å†Œ</a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Announcements Section -->
{% if announcement or current_user.is_admin %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="my-0"><i class="bi bi-megaphone"></i> ç³»ç»Ÿå…¬å‘Š</h5>
                {% if current_user.is_admin %}
                <button class="btn btn-sm btn-light text-info" type="button" data-bs-toggle="collapse" data-bs-target="#editAnnouncementForm" aria-expanded="false" aria-controls="editAnnouncementForm">
                    âœï¸ ç¼–è¾‘å…¬å‘Š
                </button>
                {% endif %}
            </div>
            
            {% if current_user.is_admin %}
            <div class="collapse" id="editAnnouncementForm">
                <div class="card-body border-bottom bg-light">
                    <form action="{{ url_for('admin.update_announcement') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="announcementContent" class="form-label">å…¬å‘Šå†…å®¹ (æ”¯æŒ HTML)</label>
                            <textarea class="form-control" id="announcementContent" name="content" rows="4">{{ announcement or '' }}</textarea>
                            <div class="form-text">æ¸…ç©ºå†…å®¹å¹¶ä¿å­˜å³å¯éšè—å…¬å‘Šæ ã€‚é€šå¸¸æ”¯æŒ HTML æ ‡ç­¾ç”¨äºæ’ç‰ˆã€‚</div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">ä¿å­˜å…¬å‘Š</button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if announcement %}
            <div class="card-body">
                <div class="announcement-content">
                    {{ announcement|safe }}
                </div>
            </div>
            {% elif current_user.is_admin %}
            <div class="card-body text-center text-muted py-2">
                <small>æš‚æ— å…¬å‘Šï¼Œç‚¹å‡»å³ä¸Šè§’ç¼–è¾‘æŒ‰é’®å‘å¸ƒæ–°å…¬å‘Šã€‚</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- User Guide Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="my-0 fw-normal">ğŸ“– ç”¨æˆ·æŒ‡å—</h4>
                {% if current_user.is_admin %}
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#editGuideForm" aria-expanded="false" aria-controls="editGuideForm">
                    âœï¸ ç¼–è¾‘æŒ‡å—
                </button>
                {% endif %}
            </div>
            
            {% if current_user.is_admin %}
            <div class="collapse" id="editGuideForm">
                <div class="card-body border-bottom bg-light">
                    <form action="{{ url_for('admin.update_guide') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="guideContent" class="form-label">æŒ‡å—å†…å®¹ (æ”¯æŒ HTML)</label>
                            <textarea class="form-control" id="guideContent" name="content" rows="10">{{ user_guide or '' }}</textarea>
                            <div class="form-text">æ‚¨å¯ä»¥ç›´æ¥ç¼–å†™ HTML ä»£ç æ¥æ’ç‰ˆæŒ‡å—å†…å®¹ã€‚</div>
                        </div>
                        <button type="submit" class="btn btn-primary">ä¿å­˜æ›´æ–°</button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if user_guide %}
            <div class="card-body">
                <div class="user-guide-content">
                    {{ user_guide|safe }}
                </div>
            </div>
            {% elif current_user.is_admin %}
            <div class="card-body text-center text-muted py-4">
                <p class="mb-0">æš‚æ— ç”¨æˆ·æŒ‡å—ï¼Œè¯·ç‚¹å‡»"ç¼–è¾‘æŒ‡å—"æŒ‰é’®è¿›è¡Œæ·»åŠ ã€‚</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if stats %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3 h-100">
            <div class="card-header">é¢˜åº“æ€»é‡</div>
            <div class="card-body">
                <h1 class="card-title display-4">{{ stats.total_questions }}</h1>
                <p class="card-text">é“å…¬å¼€é¢˜ç›®</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3 h-100">
            {% if current_user.is_authenticated and user_stats %}
                <div class="card-header">æˆ‘çš„ç­”é¢˜</div>
                <div class="card-body">
                    <h1 class="card-title display-4">{{ user_stats.total_exams }}</h1>
                    <p class="card-text">æ¬¡ä¸ªäººè®°å½•</p>
                </div>
            {% else %}
                <div class="card-header">å…¨ç«™æ€»ç­”é¢˜æ¬¡æ•°</div>
                <div class="card-body">
                    <h1 class="card-title display-4">{{ stats.total_exams }}</h1>
                    <p class="card-text">æ¬¡å…¨ç«™è®°å½•</p>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info mb-3 h-100">
            {% if current_user.is_authenticated and user_stats %}
                <div class="card-header">æˆ‘çš„æ­£ç¡®ç‡</div>
                <div class="card-body">
                    <h1 class="card-title display-4">{{ user_stats.avg_accuracy }}%</h1>
                    <p class="card-text">å¹³å‡æ­£ç¡®ç‡</p>
                </div>
            {% else %}
                <div class="card-header">å…¨ç«™å¹³å‡æ­£ç¡®ç‡</div>
                <div class="card-body">
                    <h1 class="card-title display-4">{{ stats.avg_accuracy }}%</h1>
                    <p class="card-text">æ‰€æœ‰ç”¨æˆ·å¹³å‡å€¼</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if current_user.is_admin %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <span class="fw-bold">ğŸš¦ æ™ºèƒ½æ’é˜Ÿç³»ç»Ÿç›‘æ§</span>
                <button class="btn btn-sm btn-light" onclick="updateQueueStats()">åˆ·æ–°çŠ¶æ€</button>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-6 border-end">
                        <h3 class="display-6 text-danger" id="queue-waiting">-</h3>
                        <p class="text-muted mb-0">å½“å‰æ’é˜Ÿäººæ•°</p>
                    </div>
                    <div class="col-md-6">
                        <h3 class="display-6 text-success" id="queue-active">-</h3>
                        <p class="text-muted mb-0">æ­£åœ¨è¯„åˆ†ä»»åŠ¡</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function updateQueueStats() {
    fetch('/admin/queue')
        .then(r => r.json())
        .then(data => {
            if(data.error) return;
            document.getElementById('queue-waiting').innerText = data.waiting;
            document.getElementById('queue-active').innerText = data.active;
        })
        .catch(e => console.error(e));
}
document.addEventListener('DOMContentLoaded', () => {
    updateQueueStats();
    setInterval(updateQueueStats, 5000);
});
</script>
{% endif %}

{% if user_charts %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header fw-bold">ğŸ“ˆ è¿‘æœŸæˆç»©è¶‹åŠ¿ (æœ€è¿‘7æ¬¡)</div>
            <div class="card-body">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header fw-bold">âš ï¸ é«˜é¢‘é”™é¢˜ (Top 5)</div>
            <div class="card-body">
                <canvas id="errorChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Trend Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ user_charts.trend.labels | tojson }},
                datasets: [{
                    label: 'ç­”é¢˜å¾—åˆ†',
                    data: {{ user_charts.trend.data | tojson }},
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Error Chart
        const errorCtx = document.getElementById('errorChart').getContext('2d');
        new Chart(errorCtx, {
            type: 'bar',
            data: {
                labels: {{ user_charts.errors.labels | tojson }},
                datasets: [{
                    label: 'é”™è¯¯æ¬¡æ•°',
                    data: {{ user_charts.errors.data | tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // Horizontal bar chart for better text readability
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    });
</script>
{% endif %}

<div class="row align-items-md-stretch">
    <div class="col-md-12">
        <div class="h-100 p-5 bg-light border rounded-3 text-dark">
            <h2>å…³äºæœ¬é¡¹ç›®</h2>
            <p>æœ¬ç³»ç»Ÿé‡‡ç”¨ C è¯­è¨€ç¼–å†™æ ¸å¿ƒé˜…å·é€»è¾‘ï¼ŒPython Flask æä¾› Web äº¤äº’ç•Œé¢ï¼ŒDocker å®¹å™¨æä¾›å¼€å‘å’Œéƒ¨ç½²ç¯å¢ƒï¼Œæ•°æ®åº“ä½¿ç”¨ä¸“ä¸šçº§ PostgreSQLã€‚</p>
            <hr>
            <h4>å¼€å‘è€…è”ç³»æ–¹å¼</h4>
            <ul class="list-unstyled">
                <li class="mb-2">
                    <strong>é‚®ç®±ï¼š</strong> 
                    <a href="mailto:huangmaidou608@outlook.com" class="text-decoration-none">huangmaidou608@outlook.com</a>
                </li>
                <li class="mb-2">
                    <strong>é¡¹ç›®ä»“åº“ï¼š</strong> 
                    <a href="https://github.com/pirate-608/auto-grading-system" target="_blank" class="text-decoration-none">https://github.com/pirate-608/auto-grading-system.git</a>
                </li>
            </ul>
            <a href="https://github.com/pirate-608/auto-grading-system" target="_blank" class="btn btn-dark">å‰å¾€ GitHub ä»“åº“</a>
        </div>
    </div>
</div>
{% endblock %}
